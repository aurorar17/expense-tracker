<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Expense List</title>

    <!-- CSS part -->
    <link rel="stylesheet" href="/styles/desktop.css" />
  </head>
  <body>
    <div class="wrap">
      <header>
        <script src="/classes/Header.js"></script>
      </header>

      <main>
        <section>
          Expense List
          <div id="inputFormArea">
            <script type="module">
              fetch("/pages/add-expense/index.html")
                .then((response) => response.text())
                .then((data) => {
                  document.querySelector("#inputFormArea").innerHTML = data;

                  import("/modules/category_module.js").then(
                    ({ categories }) => {
                      document
                        .getElementById("inputForm")
                        .addEventListener("submit", (e) => {
                          e.preventDefault();

                          const income =
                            document.querySelector("#income").value;
                          const category =
                            document.querySelector("#categoryList").value;
                          const date =
                            document.querySelector("input[type=date]").value;
                          const description =
                            document.querySelector("#description").value;
                          const cost =
                            parseFloat(
                              document.querySelector("input[type=number]").value
                            ) || 0;
                          const categoryName = categories.get(
                            Number(category)
                          ).name;

                          let expenses =
                            JSON.parse(localStorage.getItem("expense")) || [];

                          const newExpense = {
                            income,
                            category: categoryName,
                            date,
                            description,
                            cost,
                          };

                          expenses.push(newExpense);
                          localStorage.setItem(
                            "expense",
                            JSON.stringify(expenses)
                          );

                          document.getElementById("inputForm").reset();

                          alert("Expense added successfully!");

                          // 테이블 업데이트
                          updateTable();
                        });
                    }
                  );
                });
            </script>
          </div>
          <table id="transactionTable">
            <thead>
              <tr>
                <th></th>
                <th>Date</th>
                <th>Category</th>
                <th>Description</th>
                <th>Cost</th>
                <th>Edit</th>
                <th>Delete</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <ul></ul>
        </section>
      </main>
    </div>
  </body>

  <script src="/utils/loadFile.js"></script>
  <script type="module" src="/modules/category_module.js"></script>

  <script>
    function updateTable() {
      const expenses = JSON.parse(localStorage.getItem("expense")) || [];
      const tableBody = document.querySelector("#transactionTable tbody");
      tableBody.innerHTML = "";

      expenses.forEach((expense) => {
        const newRow = document.createElement("tr");

        if (expense.income === "income") {
          newRow.classList.add("transIncome");
        } else if (expense.income === "expense") {
          newRow.classList.add("transExpense");
        }

        newRow.innerHTML = `
          <td></td>
          <td>${expense.date}</td>
          <td>${expense.category}</td>
          <td>${expense.description}</td>
          <td>${
            expense.cost !== undefined && expense.cost !== null
              ? expense.cost.toFixed(2)
              : "0.00"
          }</td> <!-- NaN 체크 -->
          <td><button>Edit</button></td> 
          <td><button>Delete</button></td>
        `;
        tableBody.appendChild(newRow);
      });
    }

    updateTable();
  </script>
</html>
